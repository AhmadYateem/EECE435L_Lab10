pipeline {
    agent any

    environment {
        VIRTUAL_ENV = "venv"
        // Ensure Python can import from project root during tests
        PYTHONPATH = "${WORKSPACE}\\jenkins_ahmad_yateem"
    }

    stages {

        stage('Setup') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    rem Detect a usable Python on Windows
                    set "PYTHON="
                    where py >nul 2>nul
                    if %ERRORLEVEL%==0 (
                        py -3.12 -c "import sys" >nul 2>nul && set "PYTHON=py -3.12"
                        if not defined PYTHON (
                            py -3 -c "import sys" >nul 2>nul && set "PYTHON=py -3"
                        )
                    )
                    if not defined PYTHON (
                        where python >nul 2>nul && set "PYTHON=python"
                    )
                    if not defined PYTHON (
                        if exist "C:\\Python312\\python.exe" set "PYTHON=C:\\Python312\\python.exe"
                    )
                    if not defined PYTHON (
                        echo ERROR: Python not found. Install Python or configure Jenkins tool 'Python-3.12'.
                        exit /b 1
                    )
                    echo Using Python: %PYTHON%

                    if not exist %VIRTUAL_ENV% (
                        %PYTHON% -m venv %VIRTUAL_ENV%
                    )
                    call %VIRTUAL_ENV%\\Scripts\\activate
                    %PYTHON% -m pip install --upgrade pip
                    %PYTHON% -m pip install -r requirements.txt
                    '''
                }
            }
        }

        stage('Lint') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    call %VIRTUAL_ENV%\\Scripts\\activate
                    flake8 app.py tests
                    '''
                }
            }
        }

        stage('Test') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    call %VIRTUAL_ENV%\\Scripts\\activate
                    pytest --maxfail=1 --disable-warnings
                    '''
                }
            }
        }

        stage('Coverage') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    call %VIRTUAL_ENV%\\Scripts\\activate
                    coverage run -m pytest
                    coverage report --fail-under=90
                    '''
                }
            }
        }

        stage('Security Scan') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    call %VIRTUAL_ENV%\\Scripts\\activate
                    rem Exclude virtual environment and tests from Bandit scan
                    bandit -r . -x %VIRTUAL_ENV%,tests
                    '''
                }
            }
        }

        stage('Deploy') {
            steps {
                dir('jenkins_ahmad_yateem') {
                    bat '''
                    powershell -ExecutionPolicy Bypass -File deploy.ps1
                    '''
                }
            }
        }
    }

    post {
        always {
            cleanWs()
        }
    }
}
